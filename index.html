<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEIKO Arcade Hub</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(160deg, #0f172a, #1e293b);
  color: #f8fafc;
  overflow-x: hidden;
}

.app {
  max-width: 420px;
  margin: auto;
  min-height: 100vh;
  padding: 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 {
  text-align: center;
  margin: 12px 0 24px;
  font-weight: 700;
  font-size: 28px;
}

/* Hub cards */
.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  width: 100%;
}

.card {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  border-radius: 16px;
  padding: 24px 12px;
  text-align: center;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s, background 0.3s;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.card:hover {
  transform: translateY(-3px);
  background: linear-gradient(145deg, #28354a, #1c2536);
}

.card span {
  display: block;
  font-size: 36px;
  margin-bottom: 10px;
}

/* Canvas & game */
canvas {
  display: block;
  width: 100%;
  max-width: 360px;
  height: auto;
  border-radius: 14px;
  background: linear-gradient(180deg, #0f172a 0%, #020617 100%);
  margin: 20px auto;
}

button {
  padding: 12px 20px;
  border: none;
  border-radius: 14px;
  background: #f59e0b;
  color: #020617;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

button:hover {
  background: #d97706;
}

#hud {
  display: flex;
  justify-content: space-between;
  width: 100%;
  max-width: 360px;
  margin-bottom: 8px;
  font-weight: 600;
}

/* Leaderboard */
#leaderboard {
  margin-top: 16px;
  background: #1e293b;
  padding: 12px;
  border-radius: 14px;
  width: 100%;
}

#leaderboard h3 {
  margin-top: 0;
  text-align: center;
  margin-bottom: 8px;
}

#leaderboard ol {
  padding-left: 16px;
}

.hidden { display: none; }
</style>
</head>

<body>
<div class="app">

  <!-- HUB -->
  <div id="hub">
    <h1>üéÆ MEIKO ARCADE</h1>
    <div class="grid">
      <div class="card" onclick="startGame('dodge')">
        <span>üöÄ</span>Dodge Run
      </div>
      <div class="card" onclick="startGame('tap')">
        <span>‚ö°</span>Tap Speed
      </div>
      <div class="card">
        <span>üîí</span>Coming Soon
      </div>
      <div class="card" onclick="toggleLeaderboard()">
        <span>üèÜ</span>Leaderboard
      </div>
    </div>
    <div id="leaderboard" class="hidden">
      <h3>üèÜ Top Scores</h3>
      <ol id="leaderboardList"></ol>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game" class="hidden">
    <div id="hud">
      <div>Score: <span id="score">0</span></div>
      <div>Lives: <span id="lives">4</span></div>
    </div>
    <canvas id="canvas" width="360" height="480"></canvas>
    <button onclick="backToHub()">‚¨Ö Back</button>
  </div>

</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand();
tg?.ready();
tg?.lockOrientation?.("portrait");

const hub = document.getElementById("hub");
const game = document.getElementById("game");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let loopId;
let currentGame;
let lives = 4;

// Leaderboard
let leaderboard = [];
try {
  leaderboard = JSON.parse(localStorage.getItem('meiko_leaderboard') || '[]');
} catch(e){ leaderboard = []; }

function updateLeaderboard(score){
  const user = tg?.initDataUnsafe?.user?.username || 'Player';
  leaderboard.push({ user, score });
  leaderboard.sort((a,b)=>b.score-a.score);
  leaderboard = leaderboard.slice(0,5);
  localStorage.setItem('meiko_leaderboard', JSON.stringify(leaderboard));
  renderLeaderboard();
}

function renderLeaderboard(){
  const list = document.getElementById('leaderboardList');
  list.innerHTML = leaderboard.map(e=>`<li>${e.user}: ${e.score}</li>`).join('');
}

function toggleLeaderboard(){
  const lb = document.getElementById('leaderboard');
  lb.classList.toggle('hidden');
  renderLeaderboard();
}

// Navigation
function startGame(type){
  currentGame = type;
  hub.classList.add("hidden");
  game.classList.remove("hidden");
  lives = 4;
  document.getElementById('lives').innerText = lives;
  document.getElementById('score').innerText = 0;
  if(type==='dodge') startDodge();
  if(type==='tap') startTap();
}

function backToHub(){
  cancelAnimationFrame(loopId);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  game.classList.add("hidden");
  hub.classList.remove("hidden");
  renderLeaderboard();
}

// Dodge Run Game
function startDodge(){
  let player = { x: 160, y: 420, w: 40, h: 40 };
  let obs = [];
  let score = 0;

  canvas.onclick = () => {
    player.x = (player.x < 180) ? 260 : 80;
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  };

  function spawnObstacle(){
    obs.push({ x: Math.random() * (canvas.width - 30), y: -30, s: 3 + Math.random()*3 });
  }

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Draw player
    ctx.fillStyle = "#facc15";
    ctx.fillRect(player.x, player.y, player.w, player.h);

    // Draw obstacles
    ctx.fillStyle = "#38bdf8";
    obs.forEach(o=>{
      o.y += o.s;
      ctx.fillRect(o.x,o.y,30,30);
      if(o.x<player.x+player.w && o.x+30>player.x && o.y<player.y+player.h && o.y+30>player.y){
        lives--;
        document.getElementById('lives').innerText = lives;
        o.y = -30; // reset obstacle
        if(lives<=0){
          updateLeaderboard(score);
          backToHub();
        }
      }
    });

    obs = obs.filter(o=>o.y<canvas.height);
    if(Math.random()<0.03) spawnObstacle();

    score++;
    document.getElementById('score').innerText = score;

    loopId = requestAnimationFrame(loop);
  }
  loop();
}

// Tap Speed Game
function startTap(){
  let time = 300;
  let taps = 0;

  canvas.onclick = () => {
    taps++;
    if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  };

  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#f8fafc";
    ctx.font="28px sans-serif";
    ctx.fillText("TAPS: "+taps, 110, 220);
    ctx.fillText("TIME: "+Math.ceil(time/60), 110, 260);

    time--;
    if(time<=0){
      updateLeaderboard(taps);
      backToHub();
      return;
    }
    loopId = requestAnimationFrame(loop);
  }
  loop();
}

// Initial leaderboard render
renderLeaderboard();
</script>
</body>
</html>
